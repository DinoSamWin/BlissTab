# Safari æµè§ˆå™¨ Google OAuth ä¿®å¤æŒ‡å—

## ğŸ”´ é—®é¢˜

åœ¨ Safari æµè§ˆå™¨ä¸­ç‚¹å‡» Google ç™»å½•æŒ‰é’®æ—¶ï¼Œå‡ºç°è¿æ¥ä¸­æ–­é”™è¯¯ï¼š
- "Safariæµè§ˆå™¨æ— æ³•æ‰“å¼€é¡µé¢"
- "æœåŠ¡å™¨æ„å¤–ä¸­æ–­äº†è¿æ¥"
- ä½†åœ¨ Chrome å’Œ Firefox ä¸­æ­£å¸¸å·¥ä½œ

## ğŸ” é—®é¢˜æ ¹æº

è¿™æ˜¯ Safari æµè§ˆå™¨çš„å·²çŸ¥é—®é¢˜ï¼Œä¸ä»¥ä¸‹å› ç´ æœ‰å…³ï¼š

1. **Safari çš„ ITP (Intelligent Tracking Prevention)**
   - Safari çš„æ™ºèƒ½é˜²è·Ÿè¸ªåŠŸèƒ½ä¼šé˜»æ­¢ç¬¬ä¸‰æ–¹ Cookie
   - å½±å“ OAuth popup çª—å£çš„è¿æ¥

2. **Safari å¯¹ Popup çª—å£çš„å¤„ç†**
   - Safari å¯¹ popup çª—å£æœ‰æ›´ä¸¥æ ¼çš„é™åˆ¶
   - Google OAuth çš„ popup æ¨¡å¼åœ¨ Safari ä¸­å¯èƒ½å¤±è´¥

3. **è·¨åŸŸé™åˆ¶**
   - Safari çš„è·¨åŸŸç­–ç•¥æ›´ä¸¥æ ¼
   - å¯èƒ½å¯¼è‡´ OAuth æµç¨‹ä¸­æ–­

## âœ… å·²å®æ–½çš„ä¿®å¤

### 1. Safari æµè§ˆå™¨æ£€æµ‹

ä»£ç ä¸­å·²æ·»åŠ  Safari æ£€æµ‹é€»è¾‘ï¼š
```typescript
function isSafari(): boolean {
  // æ£€æµ‹ Safari æµè§ˆå™¨ï¼ˆæ’é™¤ Chrome å’Œ Chromiumï¼‰
  return /^((?!chrome|android).)*safari/i.test(navigator.userAgent) || 
         /^((?!chrome|android).)*safari/i.test(navigator.vendor);
}
```

### 2. è·³è¿‡ One Tap Promptï¼ˆSafariï¼‰

åœ¨ Safari ä¸­ï¼Œä¸æ˜¾ç¤º Google One Tap å¼¹çª—ï¼š
```typescript
// åªåœ¨é Safari æµè§ˆå™¨ä¸­æ˜¾ç¤º One Tap
if (!IS_PLACEHOLDER_ID && !hasExistingUser && !isSafariBrowser) {
  google.accounts.id.prompt(); // åªåœ¨é Safari ä¸­è°ƒç”¨
}
```

### 3. ä½¿ç”¨æŒ‰é’®ç‚¹å‡»ä»£æ›¿ Promptï¼ˆSafariï¼‰

åœ¨ Safari ä¸­ï¼Œ`openGoogleSignIn()` å‡½æ•°ä¼šï¼š
- æ£€æµ‹åˆ° Safari æ—¶ï¼Œè§¦å‘æŒ‰é’®ç‚¹å‡»è€Œä¸æ˜¯ `prompt()`
- æŒ‰é’®ä¼šè‡ªåŠ¨ä½¿ç”¨ redirect æ¨¡å¼ï¼Œé¿å… popup é—®é¢˜

## ğŸ¯ å·¥ä½œåŸç†

### Chrome/Firefoxï¼ˆæ­£å¸¸æµç¨‹ï¼‰
1. ç”¨æˆ·ç‚¹å‡»ç™»å½•æŒ‰é’®
2. Google Identity Services ä½¿ç”¨ popup çª—å£
3. ç”¨æˆ·å®Œæˆç™»å½•
4. Popup çª—å£å…³é—­ï¼Œè¿”å›ç»“æœ

### Safariï¼ˆä¿®å¤åçš„æµç¨‹ï¼‰
1. ç”¨æˆ·ç‚¹å‡»ç™»å½•æŒ‰é’®
2. **è·³è¿‡ One Tap prompt**ï¼ˆé¿å… popup é—®é¢˜ï¼‰
3. æŒ‰é’®ç‚¹å‡»è§¦å‘ **redirect æ¨¡å¼**
4. é¡µé¢è·³è½¬åˆ° Google ç™»å½•é¡µé¢
5. ç”¨æˆ·å®Œæˆç™»å½•åï¼Œé‡å®šå‘å›åŸé¡µé¢

## ğŸ“‹ éªŒè¯ä¿®å¤

### æµ‹è¯•æ­¥éª¤

1. **åœ¨ Safari ä¸­æ‰“å¼€ç½‘ç«™**
   - è®¿é—®ï¼šhttps://startlytab.vercel.app
   - æˆ–æœ¬åœ°ï¼šhttp://localhost:3000

2. **æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—**
   - åº”è¯¥çœ‹åˆ°ï¼š`[Auth] Safari detected, skipping One Tap`
   - åº”è¯¥çœ‹åˆ°ï¼š`[Auth] Browser is Safari: true`

3. **ç‚¹å‡» Google ç™»å½•æŒ‰é’®**
   - åº”è¯¥è·³è½¬åˆ° Google ç™»å½•é¡µé¢ï¼ˆè€Œä¸æ˜¯ popupï¼‰
   - ä¸åº”è¯¥å‡ºç°è¿æ¥ä¸­æ–­é”™è¯¯

4. **å®Œæˆç™»å½•**
   - åº”è¯¥æ­£å¸¸é‡å®šå‘å›ç½‘ç«™
   - åº”è¯¥æˆåŠŸç™»å½•

## âš ï¸ æ³¨æ„äº‹é¡¹

### Safari çš„ç‰¹æ®Šè¡Œä¸º

1. **One Tap ä¸ä¼šæ˜¾ç¤º**
   - è¿™æ˜¯æ­£å¸¸çš„ï¼Œå› ä¸º Safari ä¸æ”¯æŒ popup æ¨¡å¼çš„ One Tap
   - ç”¨æˆ·éœ€è¦ç‚¹å‡»æŒ‰é’®æ‰èƒ½ç™»å½•

2. **é¡µé¢ä¼šè·³è½¬**
   - Safari ä¸­ä½¿ç”¨ redirect æ¨¡å¼ï¼Œé¡µé¢ä¼šè·³è½¬åˆ° Google
   - ç™»å½•å®Œæˆåä¼šè·³è½¬å›æ¥
   - è¿™æ˜¯æ­£å¸¸çš„ Safari è¡Œä¸º

3. **é¦–æ¬¡ç™»å½•å¯èƒ½éœ€è¦é¢å¤–æ­¥éª¤**
   - Safari å¯èƒ½ä¼šè¦æ±‚ç”¨æˆ·ç¡®è®¤
   - è¿™æ˜¯ Safari çš„å®‰å…¨æœºåˆ¶

## ğŸ”§ å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨

### æ£€æŸ¥æ¸…å•

1. **ç¡®è®¤ä»£ç å·²æ›´æ–°**
   - æ£€æŸ¥ `services/authService.ts` æ˜¯å¦åŒ…å« Safari æ£€æµ‹
   - ç¡®è®¤å·²éƒ¨ç½²æœ€æ–°ç‰ˆæœ¬åˆ° Vercel

2. **æ¸…é™¤ Safari ç¼“å­˜**
   - Safari â†’ åå¥½è®¾ç½® â†’ éšç§ â†’ ç®¡ç†ç½‘ç«™æ•°æ®
   - æ¸…é™¤ `startlytab.vercel.app` å’Œ `accounts.google.com` çš„æ•°æ®

3. **æ£€æŸ¥ Safari è®¾ç½®**
   - ç¡®ä¿å…è®¸å¼¹å‡ºçª—å£ï¼ˆè™½ç„¶æˆ‘ä»¬ä¸ç”¨ popupï¼‰
   - ç¡®ä¿å…è®¸è·¨ç«™è·Ÿè¸ªï¼ˆSafari â†’ åå¥½è®¾ç½® â†’ éšç§ï¼‰

4. **å°è¯•æ— ç—•æ¨¡å¼**
   - åœ¨ Safari æ— ç—•æ¨¡å¼ä¸‹æµ‹è¯•
   - æ’é™¤æ‰©å±•æˆ–è®¾ç½®å¹²æ‰°

### æ›¿ä»£æ–¹æ¡ˆ

å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œå¯ä»¥è€ƒè™‘ï¼š

1. **ä½¿ç”¨å®Œæ•´çš„é¡µé¢è·³è½¬**
   - ä¸ä½¿ç”¨ Google Identity Services çš„æŒ‰é’®
   - ç›´æ¥è·³è½¬åˆ° Google OAuth URL

2. **ä½¿ç”¨æœåŠ¡ç«¯ OAuth æµç¨‹**
   - åœ¨åç«¯å¤„ç† OAuth
   - å‰ç«¯åªè´Ÿè´£é‡å®šå‘

## ğŸ“ æŠ€æœ¯ç»†èŠ‚

### Google Identity Services åœ¨ Safari ä¸­çš„è¡Œä¸º

- **è‡ªåŠ¨é™çº§**ï¼šGoogle Identity Services ä¼šè‡ªåŠ¨æ£€æµ‹ Safari å¹¶ä½¿ç”¨ redirect æ¨¡å¼
- **æŒ‰é’®è¡Œä¸º**ï¼šç‚¹å‡»æŒ‰é’®æ—¶ï¼ŒSafari ä¼šè‡ªåŠ¨ä½¿ç”¨ redirect è€Œä¸æ˜¯ popup
- **One Tap**ï¼šSafari ä¸æ”¯æŒ One Tap çš„ popup æ¨¡å¼

### æˆ‘ä»¬çš„ä¿®å¤ç­–ç•¥

1. **æ£€æµ‹ Safari**ï¼šåœ¨ä»£ç ä¸­æ˜ç¡®æ£€æµ‹ Safari æµè§ˆå™¨
2. **è·³è¿‡ One Tap**ï¼šä¸åœ¨ Safari ä¸­è°ƒç”¨ `prompt()`
3. **ä½¿ç”¨æŒ‰é’®**ï¼šè®©ç”¨æˆ·ç‚¹å‡»æŒ‰é’®ï¼ŒæŒ‰é’®ä¼šè‡ªåŠ¨ä½¿ç”¨ redirect æ¨¡å¼

## âœ… é¢„æœŸç»“æœ

ä¿®å¤åï¼Œåœ¨ Safari ä¸­ï¼š
- âœ… ä¸ä¼šå‡ºç°è¿æ¥ä¸­æ–­é”™è¯¯
- âœ… ç‚¹å‡»ç™»å½•æŒ‰é’®ä¼šè·³è½¬åˆ° Google ç™»å½•é¡µé¢
- âœ… ç™»å½•å®Œæˆåä¼šæ­£å¸¸è¿”å›
- âœ… åŠŸèƒ½ä¸ Chrome/Firefox ä¸€è‡´ï¼ˆåªæ˜¯æµç¨‹ç•¥æœ‰ä¸åŒï¼‰

