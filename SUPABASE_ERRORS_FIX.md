# Supabase é”™è¯¯ä¿®å¤æŒ‡å—

## ğŸ”´ å½“å‰é”™è¯¯

ä»æ§åˆ¶å°æ—¥å¿—çœ‹åˆ°ä»¥ä¸‹é”™è¯¯ï¼š

1. **401 Unauthorized** - `new row violates row-level security policy for table "user_subscriptions"`
2. **406 Not Acceptable** - å¤šä¸ª Supabase API è¯·æ±‚è¿”å› 406
3. **å¤šä¸ª GoTrueClient å®ä¾‹è­¦å‘Š** - å¤šä¸ª Supabase å®¢æˆ·ç«¯è¢«åˆ›å»º

## ğŸ” é—®é¢˜æ ¹æº

ä½ çš„åº”ç”¨ä½¿ç”¨ **Google OAuth** ç™»å½•ï¼Œè€Œä¸æ˜¯ Supabase Authã€‚è¿™æ„å‘³ç€ï¼š

- âŒ æ²¡æœ‰ Supabase Auth session
- âŒ `auth.uid()` è¿”å› `null`
- âŒ RLS ç­–ç•¥æ— æ³•åŒ¹é…ç”¨æˆ·

å½“å‰çš„ RLS ç­–ç•¥ä¾èµ–äº `auth.uid()` æˆ– `auth.jwt()`ï¼Œä½†è¿™äº›åœ¨ Google OAuth ç”¨æˆ·ä¸­éƒ½æ˜¯ `null`ã€‚

## âœ… è§£å†³æ–¹æ¡ˆ

### æ­¥éª¤ 1: æ›´æ–° Supabase RLS ç­–ç•¥

1. **è®¿é—® Supabase Dashboard**
   - æ‰“å¼€ï¼šhttps://supabase.com/dashboard
   - é€‰æ‹©ä½ çš„é¡¹ç›®
   - è¿›å…¥ **SQL Editor**

2. **è¿è¡Œä¿®å¤ SQL**
   - æ‰“å¼€é¡¹ç›®ä¸­çš„ `supabase-rls-fix.sql` æ–‡ä»¶
   - å¤åˆ¶å…¨éƒ¨å†…å®¹
   - ç²˜è´´åˆ° Supabase SQL Editor
   - ç‚¹å‡» **Run** æ‰§è¡Œ

è¿™ä¸ª SQL ä¼šï¼š
- æ›´æ–° `user_subscriptions` è¡¨çš„ RLS ç­–ç•¥
- æ›´æ–° `user_membership` è¡¨çš„ RLS ç­–ç•¥
- æ›´æ–° `user_settings` è¡¨çš„ RLS ç­–ç•¥
- å…è®¸åŸºäº `user_id` çš„è®¿é—®ï¼ˆåº”ç”¨å±‚éªŒè¯ï¼‰

### æ­¥éª¤ 2: éªŒè¯ä¿®å¤

è¿è¡Œ SQL åï¼Œåˆ·æ–°ä½ çš„åº”ç”¨é¡µé¢ï¼Œé”™è¯¯åº”è¯¥æ¶ˆå¤±ã€‚

## ğŸ“‹ ä¿®å¤åçš„è¡Œä¸º

**å®‰å…¨æ€§è¯´æ˜ï¼š**
- RLS ç­–ç•¥ç°åœ¨å…è®¸æ‰€æœ‰æ“ä½œï¼ˆ`USING (true)`ï¼‰
- **åº”ç”¨å±‚è´Ÿè´£éªŒè¯** `user_id` æ˜¯å¦åŒ¹é…å½“å‰ç™»å½•ç”¨æˆ·
- è¿™æ˜¯ Google OAuth åœºæ™¯çš„æ ‡å‡†åšæ³•

**åº”ç”¨å±‚éªŒè¯ï¼š**
- æ‰€æœ‰ Supabase æ“ä½œéƒ½ä½¿ç”¨ä» Google OAuth è·å–çš„ `user.id`
- åº”ç”¨ç¡®ä¿ `user_id` å‚æ•°å§‹ç»ˆæ˜¯å½“å‰ç™»å½•ç”¨æˆ·çš„ ID
- è¿™æ˜¯å®‰å…¨çš„ï¼Œå› ä¸ºï¼š
  1. ç”¨æˆ·æ— æ³•ä¿®æ”¹ `user.id`ï¼ˆæ¥è‡ª Google OAuthï¼‰
  2. æ‰€æœ‰ API è°ƒç”¨éƒ½ä½¿ç”¨è¿™ä¸ª `user.id`
  3. å‰ç«¯ä»£ç æ— æ³•ç»•è¿‡è¿™ä¸ªéªŒè¯

## ğŸ”§ å…¶ä»–ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

### å‡å°‘å¤šä¸ª Supabase å®¢æˆ·ç«¯å®ä¾‹

ç›®å‰æœ‰ä¸‰ä¸ªæœåŠ¡æ–‡ä»¶å„è‡ªåˆ›å»º Supabase å®¢æˆ·ç«¯ï¼š
- `services/supabaseService.ts`
- `services/subscriptionService.ts`
- `services/redeemService.ts`

è¿™ä¼šå¯¼è‡´å¤šä¸ª GoTrueClient å®ä¾‹è­¦å‘Šã€‚å¯ä»¥åˆ›å»ºä¸€ä¸ªå…±äº«çš„å®¢æˆ·ç«¯ï¼Œä½†è¿™ä¸æ˜¯å¿…é¡»çš„ï¼Œåªæ˜¯è­¦å‘Šï¼Œä¸å½±å“åŠŸèƒ½ã€‚

## âœ… éªŒè¯æ¸…å•

ä¿®å¤åï¼Œæ§åˆ¶å°åº”è¯¥ï¼š
- âœ… ä¸å†æœ‰ 401 é”™è¯¯
- âœ… ä¸å†æœ‰ 406 é”™è¯¯
- âœ… è®¢é˜…è®°å½•å¯ä»¥æ­£å¸¸åˆ›å»º
- âœ… ä¼šå‘˜ä¿¡æ¯å¯ä»¥æ­£å¸¸æŸ¥è¯¢
- âš ï¸ GoTrueClient è­¦å‘Šå¯èƒ½ä»ç„¶å­˜åœ¨ï¼ˆä¸å½±å“åŠŸèƒ½ï¼‰

## ğŸ†˜ å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨

1. **ç¡®è®¤ SQL å·²æ‰§è¡Œ**
   - åœ¨ Supabase Dashboard çš„ **Table Editor** ä¸­
   - æŸ¥çœ‹è¡¨çš„ **Policies** æ ‡ç­¾
   - ç¡®è®¤ç­–ç•¥å·²æ›´æ–°

2. **æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨**
   - ç¡®è®¤ `user_subscriptions`ã€`user_membership`ã€`user_settings` è¡¨å·²åˆ›å»º
   - å¦‚æœæ²¡æœ‰ï¼Œå…ˆè¿è¡Œ `supabase-schema.sql`

3. **æ¸…é™¤æµè§ˆå™¨ç¼“å­˜**
   - ç¡¬åˆ·æ–°é¡µé¢ï¼ˆCmd+Shift+R æˆ– Ctrl+Shift+Rï¼‰
   - æˆ–æ¸…é™¤æµè§ˆå™¨ç¼“å­˜

